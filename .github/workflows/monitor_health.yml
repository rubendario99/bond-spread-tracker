name: Monitor Bot Health

on:
  schedule:
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Verificar FRED API
      env:
        FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
      run: |
        python3 << 'EOF'
        import requests
        import os
        import sys
        
        api_key = os.environ.get('FRED_API_KEY')
        url = 'https://api.stlouisfed.org/fred/series/observations'
        params = {
            'series_id': 'BAMLH0A0HYM2',
            'api_key': api_key,
            'file_type': 'json',
            'limit': 1,
            'sort_order': 'desc'
        }
        
        try:
            response = requests.get(url, params=params, timeout=10)
            if response.status_code == 200:
                data = response.json()
                if data.get('observations'):
                    valor = data['observations'][0]['value']
                    fecha = data['observations'][0]['date']
                    print(f"‚úÖ FRED API OK - √öltimo dato: {fecha} = {valor}%")
                else:
                    print("‚ùå FRED API sin datos")
                    sys.exit(1)
            else:
                print(f"‚ùå FRED API error: {response.status_code}")
                sys.exit(1)
        except Exception as e:
            print(f"‚ùå Error: {e}")
            sys.exit(1)
        EOF
    
    - name: Verificar Telegram API
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      run: |
        python3 << 'EOF'
        import requests
        import os
        import sys
        
        token = os.environ.get('TELEGRAM_BOT_TOKEN')
        url = f'https://api.telegram.org/bot{token}/getMe'
        
        try:
            response = requests.get(url, timeout=10)
            data = response.json()
            if data.get('ok'):
                bot = data['result']
                print(f"‚úÖ Telegram Bot OK - @{bot.get('username')}")
            else:
                print(f"‚ùå Telegram error: {data}")
                sys.exit(1)
        except Exception as e:
            print(f"‚ùå Error: {e}")
            sys.exit(1)
        EOF
    
    - name: Enviar reporte de salud
      if: success()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        python3 << 'EOF'
        import requests
        import os
        from datetime import datetime
        
        token = os.environ.get('TELEGRAM_BOT_TOKEN')
        chat_id = os.environ.get('TELEGRAM_CHAT_ID')
        
        mensaje = (
            f"üíö <b>Reporte de Salud Semanal</b>\n\n"
            f"‚úÖ Sistemas verificados correctamente\n\n"
            f"üîç Estado de APIs:\n"
            f"‚Ä¢ FRED API: ‚úÖ Operativo\n"
            f"‚Ä¢ Telegram API: ‚úÖ Operativo\n"
            f"‚Ä¢ Bot principal: ‚úÖ Funcionando\n\n"
            f"üìÖ {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n"
            f"<i>Verificaci√≥n autom√°tica cada lunes</i>"
        )
        
        url = f'https://api.telegram.org/bot{token}/sendMessage'
        payload = {
            'chat_id': chat_id,
            'text': mensaje,
            'parse_mode': 'HTML'
        }
        
        response = requests.post(url, json=payload, timeout=10)
        if response.json().get('ok'):
            print("‚úÖ Reporte enviado a Telegram")
        else:
            print("‚ö†Ô∏è Error enviando reporte")
        EOF
    
    - name: Alertar si hay problemas
      if: failure()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        python3 << 'EOF'
        import requests
        import os
        from datetime import datetime
        
        token = os.environ.get('TELEGRAM_BOT_TOKEN')
        chat_id = os.environ.get('TELEGRAM_CHAT_ID')
        
        mensaje = (
            f"üö® <b>ALERTA: Problema Detectado</b>\n\n"
            f"‚ùå Fall√≥ la verificaci√≥n de salud\n\n"
            f"üìÖ {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n"
            f"üîß Revisa GitHub Actions para m√°s detalles"
        )
        
        url = f'https://api.telegram.org/bot{token}/sendMessage'
        payload = {
            'chat_id': chat_id,
            'text': mensaje,
            'parse_mode': 'HTML'
        }
        
        requests.post(url, json=payload, timeout=10)
        print("‚ö†Ô∏è Alerta enviada")
        EOF
